#!/usr/bin/env bash
# Auto-bump patch version before every commit
# The version bump is staged automatically so it's included in the same commit.

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
MARKETPLACE_JSON="$REPO_ROOT/.claude-plugin/marketplace.json"

# Read current version
CURRENT=$(python3 -c "import json; print(json.load(open('$MARKETPLACE_JSON'))['plugins'][0]['version'])")

# Bump patch
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
PATCH=$((PATCH + 1))
NEW_VERSION="$MAJOR.$MINOR.$PATCH"

echo "Auto-bumping plugin version: $CURRENT → $NEW_VERSION"

# Update marketplace.json
python3 -c "
import json
with open('$MARKETPLACE_JSON', 'r') as f:
    data = json.load(f)
data['plugins'][0]['version'] = '$NEW_VERSION'
with open('$MARKETPLACE_JSON', 'w') as f:
    json.dump(data, f, indent=2)
    f.write('\n')
"

# Stage the version bump so it's included in this commit
git add "$MARKETPLACE_JSON"

echo "✓ Version bumped to $NEW_VERSION (staged)"
